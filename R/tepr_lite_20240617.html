<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Obtaining AUC for each gene</title>
<style type="text/css">
/**
 * Prism.s theme ported from highlight.js's xcode style
 */
pre code {
  padding: 1em;
}
.token.comment {
  color: #007400;
}
.token.punctuation {
  color: #999;
}
.token.tag,
.token.selector {
  color: #aa0d91;
}
.token.boolean,
.token.number,
.token.constant,
.token.symbol {
  color: #1c00cf;
}
.token.property,
.token.attr-name,
.token.string,
.token.char,
.token.builtin {
  color: #c41a16;
}
.token.inserted {
  background-color: #ccffd8;
}
.token.deleted {
  background-color: #ffebe9;
}
.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
}
.token.atrule,
.token.attr-value,
.token.keyword {
  color: #836c28;
}
.token.function,
.token.class-name {
  color: #DD4A68;
}
.token.regex,
.token.important,
.token.variable {
  color: #5c2699;
}
.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}
</style>
<style type="text/css">
body {
  font-family: sans-serif;
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
body, .footnotes, code { font-size: .9em; }
li li { font-size: .95em; }
*, *:before, *:after {
  box-sizing: inherit;
}
pre, img { max-width: 100%; }
pre, pre:hover {
  white-space: pre-wrap;
  word-break: break-all;
}
pre code {
  display: block;
  overflow-x: auto;
}
code { font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace; }
:not(pre) > code, code[class] { background-color: #F8F8F8; }
code.language-undefined, pre > code:not([class]) {
  background-color: inherit;
  border: 1px solid #eee;
}
table {
  margin: auto;
  border-top: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color: #666;
  margin: 0;
  padding-left: 1em;
  border-left: 0.5em solid #eee;
}
hr, .footnotes::before { border: 1px dashed #ddd; }
.frontmatter { text-align: center; }
#TOC .numbered li { list-style: none; }
#TOC .numbered { padding-left: 0; }
#TOC .numbered ul { padding-left: 1em; }
table, .body h2 { border-bottom: 1px solid #666; }
.body .appendix, .appendix ~ h2 { border-bottom-style: dashed; }
.footnote-ref a::before { content: "["; }
.footnote-ref a::after { content: "]"; }
section.footnotes::before {
  content: "";
  display: block;
  max-width: 20em;
}

@media print {
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  tr, img { page-break-inside: avoid; }
}
@media only screen and (min-width: 992px) {
  pre { white-space: pre; }
}
</style>
</head>
<body>
<div class="frontmatter">
<div class="title"><h1>Obtaining AUC for each gene</h1></div>
<div class="author"><h2>Victor Billon</h2></div>
<div class="date"><h3>2024-06-17</h3></div>
</div>
<div class="body">
<p>list of functions necessary to create the two tables:
Functions can be ran in the order of the markdown</p>
<pre><code class="language-r">  getting_var_names(extension, working_directory)
</code></pre>
<pre><code>## Error in getting_var_names(extension, working_directory): could not find function &quot;getting_var_names&quot;
</code></pre>
<pre><code class="language-r">## to obtain the different condition names and replicates inside the folder containing the bedgraph files used to create the .tsv

  main_table_read(name_table, extension, working_directory, expression_threshold)
</code></pre>
<pre><code>## Error in main_table_read(name_table, extension, working_directory, expression_threshold): could not find function &quot;main_table_read&quot;
</code></pre>
<pre><code class="language-r">## to load the tsv and select the expressed genes  
  
  genesECDF(main_table, rounding, expressed_transcript_name_list, extension, working_directory)
</code></pre>
<pre><code>## Error in genesECDF(main_table, rounding, expressed_transcript_name_list, : could not find function &quot;genesECDF&quot;
</code></pre>
<pre><code class="language-r">## to create the table necessary to get the cumulative density 
  
  calculates_meanFx(concat_df,window_number)
</code></pre>
<pre><code>## Error in calculates_meanFx(concat_df, window_number): could not find function &quot;calculates_meanFx&quot;
</code></pre>
<pre><code class="language-r">## to create distribution function from the density obtained
  
  condition_comparison(extension,working_directory)
</code></pre>
<pre><code>## Error in condition_comparison(extension, working_directory): could not find function &quot;condition_comparison&quot;
</code></pre>
<pre><code class="language-r">## function that gives all conditions that will be compared. 

    condition_compared(extension,working_directory,dontcompare=NULL)
</code></pre>
<pre><code>## Error in condition_compared(extension, working_directory, dontcompare = NULL): could not find function &quot;condition_compared&quot;
</code></pre>
<pre><code class="language-r">## function to tell which condition from condition_comparaison to not compare. Prevents to have too big tables by comparing useless condition pairs
    
  Diff_mean_fun(concat_df, dontcompare=NULL)
</code></pre>
<pre><code>## Error in Diff_mean_fun(concat_df, dontcompare = NULL): could not find function &quot;Diff_mean_fun&quot;
</code></pre>
<pre><code class="language-r">## Calculates differences between conditions
  
  modify_p_values(col)
</code></pre>
<pre><code>## Error in modify_p_values(col): could not find function &quot;modify_p_values&quot;
</code></pre>
<pre><code class="language-r">## associate threshold to the minimum pvale
  
  dAUC_allcondi_fun(concat_df,window_number, dontcompare)
</code></pre>
<pre><code>## Error in dAUC_allcondi_fun(concat_df, window_number, dontcompare): could not find function &quot;dAUC_allcondi_fun&quot;
</code></pre>
<pre><code class="language-r">## to do the statistics and KS-test 
  
  AUC_allcondi_fun(concat_df,window_number)
</code></pre>
<pre><code>## Error in AUC_allcondi_fun(concat_df, window_number): could not find function &quot;AUC_allcondi_fun&quot;
</code></pre>
<pre><code class="language-r">## Calculate the Area Under Curve (AUC), All conditions vs y=x. Calculate Mean Value over the full gene body in All conditions.
  
  countNA_fun(main_table,extension,working_directory)
</code></pre>
<pre><code>## Error in countNA_fun(main_table, extension, working_directory): could not find function &quot;countNA_fun&quot;
</code></pre>
<pre><code class="language-r">## count the number of windows with NAs per genes
  
  KneeID_fun(concat_df)
</code></pre>
<pre><code>## Error in KneeID_fun(concat_df): could not find function &quot;KneeID_fun&quot;
</code></pre>
<pre><code class="language-r">## Get knee position for attenuation
</code></pre>
<h1 id="packages">Packages</h1>
<pre><code class="language-r"># install.packages(&quot;multimode&quot;) 
# install.packages(&quot;ggplot2&quot;)
# install.packages(&quot;moments&quot;) 
# install.packages(&quot;tidyverse&quot;)
# install.packages(&quot;inflection&quot;)
# install.packages(&quot;reticulate&quot;) 
# install.packages(&quot;ggside&quot;)
# install.packages(&quot;tidyverse&quot;)
# install.packages(&quot;tidyquant&quot;)
</code></pre>
<h2 id="loading">Loading</h2>
<h1 id="datasets">Datasets</h1>
<p>Cugusi 2reps
example to load the tsv on Cugusi dataset:</p>
<pre><code class="language-r">#setting columns names
#files names have to be : condition_rep#.strand, a condition can contain several sub condition (cond1a_cond1b)

working_directory &lt;- &quot;/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/Cugusi2022/RAW_TTseq/deduplicated/MAPQ255/stranded/bedgraph255&quot; 
## in the working directory the files are: 
# ctrl_rep1.forward.bg  ctrl_rep2.forward.bg  HS_rep1.forward.bg  HS_rep2.forward.bg
# ctrl_rep1.reverse.bg  ctrl_rep2.reverse.bg  HS_rep1.reverse.bg  HS_rep2.reverse.bg
# Cugusi_protein-lncRNA_stranded_analysis_MAPQ255_20230705.tsv 

extension &lt;- &quot;*.bg&quot;
name_table &lt;- &quot;Cugusi_protein-lncRNA_stranded_analysis_MAPQ255_20230705.tsv&quot;
rounding &lt;- 10
</code></pre>
<h1 id="functions-to-call">Functions to call</h1>
<h2 id="defining-to-column-names-with-getting-var-names">Defining to column names with getting_var_names()</h2>
<p>getting_var_names
This function uses the extension and working directory to get the condition names, the number of replicates, and the variable names.
It needs the file names to be written in the form:
Condition_rep#.strand.extension such as :
HS_rep1.reverse.bg
from the scoring file the colnames must be:
fixed_names &lt;- c(“biotype”,“chr”, “coor1”, “coor2”,“transcript”, “gene”, “strand”,“window”,“id”)</p>
<pre><code class="language-r">getting_var_names &lt;- function(extension, working_directory) {
  
# This function uses the extension and working directory to get the condition names, the number of replicates, and the variable names.
# It needs the file names to be written in the form:
# Condition_rep#.strand.extension such as :
# HS_rep1.reverse.bg
  
  
# In input: extension such as &quot;*.bg&quot; and the working directory
  
  
  bedgraph_files &lt;- list.files(working_directory, pattern = extension, full.names = TRUE)
  files &lt;- bedgraph_files %&gt;%
    map(~{
      filename &lt;- tools::file_path_sans_ext(basename(.))
    })
  
  string &lt;- files
  var_names &lt;- string
  
  for (i in seq_along(var_names)) {
    if (grepl(&quot;(reverse|forward)&quot;, var_names[i])) {
      var_names[i] &lt;- gsub(&quot;reverse&quot;, &quot;minus&quot;, var_names[i])
      var_names[i] &lt;- gsub(&quot;forward&quot;, &quot;plus&quot;, var_names[i])
    }
  }
  
  # Extract conditions
  Conditions &lt;- unique(sub(&quot;(\\w+)_rep\\d+.*&quot;, &quot;\\1&quot;, var_names)) ## verify it can work with several &quot;_&quot; 
  
  # Extract replication numbers
  replicate_numbers &lt;- unique(sub(&quot;.*_rep(\\d+).*&quot;, &quot;\\1&quot;, var_names))
  
  ###########
  # Setting fixed column names
  fixed_names &lt;- c(&quot;biotype&quot;,&quot;chr&quot;, &quot;coor1&quot;, &quot;coor2&quot;,&quot;transcript&quot;, &quot;gene&quot;, &quot;strand&quot;,&quot;window&quot;,&quot;id&quot;) #biotype is added in the .tsv file
  
  num_fixed_cols &lt;- length(fixed_names)
  # Number of variable columns based on input file
  num_var_cols &lt;- ncol(table) - num_fixed_cols
  #Generate variable column names for category 2, alternating with category 1
  test &lt;- rep(var_names, each=2)
  suffix &lt;- rep(c(&quot;&quot;, &quot;_score&quot;), length(var_names))
  test &lt;- paste0(test, suffix)
  col_names &lt;- c(fixed_names, test)
  
  return(list(col_names=col_names,var_names=var_names, replicate_numbers=replicate_numbers, Conditions=Conditions)) 
}
</code></pre>
<pre><code class="language-r">library(dplyr)
library(purrr)
getting_var_names(extension, working_directory)
</code></pre>
<pre><code>## $col_names
## [1] &quot;biotype&quot;    &quot;chr&quot;        &quot;coor1&quot;      &quot;coor2&quot;      &quot;transcript&quot;
## [6] &quot;gene&quot;       &quot;strand&quot;     &quot;window&quot;     &quot;id&quot;        
## 
## $var_names
## list()
## 
## $replicate_numbers
## character(0)
## 
## $Conditions
## character(0)
</code></pre>
<h1 id="creating-concatenated-dataset">Creating concatenated dataset</h1>
<p>library(utils) # for the upload bar
detach(package:plyr) #is needed to do the group_by if plyr has been load after dplyr</p>
<h2 id="main-table-read">main_table_read()</h2>
<p>main_table_read
/!/ to verify that names from *.tsv and file names are the same and ordered the same way (it is by default alphabetical, so unless filenames have been changed after the creation of the tsv there is no problem)</p>
<pre><code class="language-r">main_table_read &lt;- function(name_table, extension, working_directory, expression_threshold){

df_final &lt;- data.frame()
df_final_gene &lt;- data.frame()
concat_df &lt;- data.frame()
gene_name_list &lt;- character()
expressed_gene_name_list &lt;- character()

#file
#Load data without header
res &lt;- getting_var_names(extension, working_directory)
col_names &lt;- res$col_names
var_names &lt;- res$var_names

main_table &lt;- data.frame()

main_table &lt;- read.delim(paste0(working_directory,&quot;/&quot;,name_table),
                      header = FALSE, # set header = FALSE to avoid overwriting it
                      sep=&quot;\t&quot;,
                      col.names = col_names )


for (gene in unique(main_table$gene)){
  gene_name_list &lt;- c(gene_name_list, gene)
}
sorted_list &lt;- sort(gene_name_list, decreasing = F)
#print(length(sorted_list))
#####

# Get the column names with the suffix &quot;score&quot;
score_columns &lt;- grep(&quot;score$&quot;, col_names, value = TRUE)

# Initialize an empty list to store the mean column names
mean_column_names &lt;- list()
expressed_gene_name &lt;- data.frame()
expressed_plus &lt;- data.frame()

expressed_transcript_name &lt;- main_table %&gt;%
  group_by(transcript) %&gt;%
  dplyr::summarize(gene=gene[1],strand=strand[1],
                   across(all_of(score_columns), ~ mean(., na.rm = TRUE), .names = &quot;{.col}_mean&quot;)
  )


expressed_plus &lt;- expressed_transcript_name %&gt;%
  filter(strand==&quot;+&quot;) %&gt;% 
  select(gene, transcript, strand, contains(&quot;plus&quot;))  %&gt;%
  filter(across(all_of(contains(&quot;score&quot;)), ~ !is.na(.) ) ) %&gt;%
  filter(across(all_of(contains(&quot;score&quot;)), ~ . &gt;expression_threshold ) )

expressed_minus &lt;- expressed_transcript_name %&gt;%
  filter(strand==&quot;-&quot;) %&gt;% 
  select(gene,transcript, strand, contains(&quot;minus&quot;)) %&gt;%
  filter(across(all_of(contains(&quot;score&quot;)), ~ !is.na(.) ) ) %&gt;%
  filter(across(all_of(contains(&quot;score&quot;)), ~ . &gt;expression_threshold ) )

expressed_transcript_name_list &lt;- bind_rows(expressed_plus, expressed_minus) %&gt;% arrange(transcript) %&gt;% pull(transcript)
#print(length(expressed_transcript_name_list)) ## this will set the loading bar

return(list(main_table=main_table,expressed_transcript_name_list=expressed_transcript_name_list))

}
</code></pre>
<pre><code class="language-r">library(tidyr)
library(purrr)
library(dplyr)

results_main_table &lt;- main_table_read(name_table, extension, working_directory, 0.1)
</code></pre>
<pre><code>## Warning in file(file, &quot;rt&quot;): cannot open file
## '/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/Cugusi2022/RAW_TTseq/deduplicated/MAPQ255/stranded/bedgraph255/Cugusi_protein-lncRNA_stranded_analysis_MAPQ255_20230705.tsv':
## No such file or directory
</code></pre>
<pre><code>## Error in file(file, &quot;rt&quot;): cannot open the connection
</code></pre>
<pre><code class="language-r">main_table &lt;- results_main_table$main_table # %&gt;% filter(gene==&quot;DAP&quot;)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'results_main_table' not found
</code></pre>
<pre><code class="language-r">expressed_transcript_name_list  &lt;-  results_main_table$expressed_transcript_name_list 
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'results_main_table' not found
</code></pre>
<pre><code class="language-r">#expressed_transcript_name_list  &lt;- &quot;ENST00000230895.11&quot;
</code></pre>
<h2 id="genesecdf">genesECDF()</h2>
<p>genesECDF is the long part of the code, it converts the value for the windows of a gene to the cumulative density</p>
<pre><code class="language-r">genesECDF &lt;- function(main_table, rounding, expressed_transcript_name_list, extension, working_directory){
gc()
  
res &lt;- getting_var_names(extension, working_directory)
col_names &lt;- res$col_names
var_names &lt;- res$var_names  
  
total_iterations &lt;- length(expressed_transcript_name_list)
#setting the progress bar
pb &lt;- txtProgressBar(min = 0, max = total_iterations, style =5)

j=0
concat_df &lt;- data.frame()
## Looping through all the transcripts
for (variable in expressed_transcript_name_list){
  gene_table &lt;- data.frame()
  bigDF &lt;- data.frame()  
  
  transcript_table &lt;- data.frame()
  transcript &lt;- filter(main_table, main_table$transcript==variable) 
  transcript[transcript == &quot;NAN&quot;] &lt;- NA
  bigDF &lt;- transcript
  my_length &lt;- length(bigDF[,'window'])
  
  
  var_names_score &lt;- paste0(var_names,&quot;_score&quot;)
  
  if (transcript$strand[1]==&quot;-&quot;) {
    bigDF &lt;- bigDF %&gt;%
      select(!matches(&quot;plus&quot;))
    bigDF$coord &lt;- seq(from=my_length, to=1,by=-1)
    bigDF &lt;- arrange(bigDF, coord)
    conditions &lt;- var_names_score[grepl(&quot;minus&quot;,var_names_score)]
  } else {
    bigDF &lt;- bigDF %&gt;%
      select(!matches(&quot;minus&quot;))
    bigDF$coord &lt;- seq(from=1, to=my_length,by=1)
    conditions &lt;- var_names_score[grepl(&quot;plus&quot;,var_names_score)]
  }
  
  bigDF &lt;- bigDF %&gt;% fill(contains(&quot;score&quot;), .direction = &quot;downup&quot;)
  
  df_long &lt;- bigDF %&gt;% 
    gather(key = &quot;variable&quot;, value = &quot;value&quot;, conditions)
  df_long[,'value'] &lt;- as.numeric(df_long[,'value'])
  df_long[,'value_round']&lt;- round(df_long$value*rounding)
  
  j=j+1
#  Update the progress bar
  setTxtProgressBar(pb, j)
  
  list_df &lt;- list()
  i &lt;- 1
  for (my_var in unique(df_long$variable)){
    
    df_subset &lt;- subset(df_long, subset = variable == my_var) 
    df_expanded &lt;- df_subset[rep(seq_len(nrow(df_subset)), df_subset$value_round), ]
    ecdf_df &lt;- ecdf(df_expanded[,&quot;coord&quot;])
    df_subset$Fx &lt;- ecdf_df(df_subset$coord) 
    list_df[[i]] &lt;- df_subset
    i &lt;- i + 1
  }
  
  df_final &lt;- bind_rows(list_df)
  transcript_table &lt;- df_final  %&gt;% pivot_wider(., names_from = &quot;variable&quot;, values_from = c(&quot;value&quot;, &quot;value_round&quot;, &quot;Fx&quot;)) %&gt;% select(., -contains(&quot;value_round&quot;)) 
  
  # getting rid of plus and minus
  if (transcript_table$strand[1]==&quot;-&quot;) {
    # Drop columns containing &quot;minus&quot;
    columns_to_drop &lt;- grep(&quot;plus&quot;, names(col_names), value = TRUE)
    dataset_without_dropped &lt;- transcript_table %&gt;%
      select(-all_of(columns_to_drop))
    
    # Modify column names by removing &quot;_plus&quot;
    modified_dataset &lt;- dataset_without_dropped %&gt;%
      rename_with(~gsub(&quot;.minus&quot;, &quot;&quot;, .), contains(&quot;.minus&quot;))
    
  } else {
    # Drop columns containing &quot;minus&quot;
    columns_to_drop &lt;- grep(&quot;minus&quot;, names(col_names), value = TRUE)
    dataset_without_dropped &lt;- transcript_table %&gt;%
      select(-all_of(columns_to_drop))
    
    # Modify column names by removing &quot;_plus&quot;
    modified_dataset &lt;- dataset_without_dropped %&gt;%
      rename_with(~gsub(&quot;.plus&quot;, &quot;&quot;, .), contains(&quot;.plus&quot;))
    
  }
  concat_df &lt;- bind_rows(concat_df, modified_dataset)
  
}

# # Close the progress bar
 close(pb)  
# list_gene_table &lt;- concat_df %&gt;% select(gene) %&gt;% distinct()
gc()

return(concat_df=concat_df)
}
</code></pre>
<pre><code class="language-r">resultsECDF &lt;- genesECDF(main_table, rounding, expressed_transcript_name_list, extension, working_directory)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'expressed_transcript_name_list' not found
</code></pre>
<h2 id="write-and-read-ecdf-tsv">Write and Read ECDF.tsv</h2>
<pre><code class="language-r">PATH &lt;- &quot;/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/SousaLuis2021/&quot;
rounding &lt;- 10
window_n &lt;- 200
PaperYear &lt;- &quot;SousaLuis2021_PlaB&quot;
</code></pre>
<pre><code class="language-r">## resultsECDF is important for cumulative transcription plot
resultsECDF_path &lt;- paste0(PATH,PaperYear,&quot;_ECDFScores_&quot;,rounding,&quot;_&quot;,window_n,&quot;.tsv&quot;)
write.table(resultsECDF, file = resultsECDF_path, sep = &quot;\t&quot;, quote = FALSE, row.names = FALSE, col.names = T)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'resultsECDF' not found
</code></pre>
<pre><code class="language-r">rm(main_table,results_main_table)
</code></pre>
<pre><code>## Warning in rm(main_table, results_main_table): object 'main_table' not found
</code></pre>
<pre><code>## Warning in rm(main_table, results_main_table): object 'results_main_table' not
## found
</code></pre>
<pre><code class="language-r">gc()
</code></pre>
<pre><code>##           used  (Mb) gc trigger (Mb) max used  (Mb)
## Ncells 2164198 115.6    4361044  233  2809858 150.1
## Vcells 4151833  31.7    8388608   64  6514607  49.8
</code></pre>
<h1 id="analysis-function">Analysis function:</h1>
<h2 id="work-on-concat-df">Work on concat_df</h2>
<h3 id="calculates-meanfx">calculates_meanFx()</h3>
<p>Here i get the mean per value</p>
<pre><code class="language-r">calculates_meanFx &lt;- function(concat_df,window_number){

res &lt;- getting_var_names(extension, working_directory)
Conditions &lt;- res$Conditions
replicate_numbers &lt;- res$replicate_numbers


column_vector_value &lt;- character()
column_vector_Fx &lt;- character()


for (cond in Conditions) {
  mean_value_condi_name &lt;- paste0(&quot;mean_value_&quot;, cond)
  mean_Fx_condi_name &lt;- paste0(&quot;mean_Fx_&quot;, cond)
  diff_Fx_condi_name &lt;- paste0(&quot;diff_Fx_&quot;, cond)
  
  for (rep_num in replicate_numbers) {
    new_column_value &lt;- paste0(&quot;value_&quot;, cond, &quot;_rep&quot;, rep_num, &quot;_score&quot;) # Generate a new item
    new_column_Fx &lt;- paste0(&quot;Fx_&quot;, cond, &quot;_rep&quot;, rep_num, &quot;_score&quot;) # Generate a new item
    column_vector_value &lt;- c(column_vector_value, new_column_value)
    column_vector_Fx &lt;- c(column_vector_Fx, new_column_Fx)
  }
  # Calculate row means for the specified columns
  # Check if there is more than one replicate
  if (length(replicate_numbers) &gt; 1) {
    concat_df[[mean_value_condi_name]] &lt;- rowMeans(concat_df[, column_vector_value], na.rm = F)
    concat_df[[mean_Fx_condi_name]] &lt;- rowMeans(concat_df[, column_vector_Fx], na.rm = FALSE)
  } else {
    # Handle case when column_vector_value is empty
    new_column_value &lt;- paste0(&quot;value_&quot;, cond, &quot;_rep&quot;, &quot;1&quot;, &quot;_score&quot;) # Generate a new item
    new_column_Fx &lt;- paste0(&quot;Fx_&quot;, cond, &quot;_rep&quot;, &quot;1&quot;, &quot;_score&quot;) # Generate a new item
    
    concat_df[[mean_value_condi_name]] &lt;- concat_df[[new_column_value]]
    concat_df[[mean_Fx_condi_name]] &lt;- concat_df[[new_column_Fx]]
  }
  
  concat_df[[diff_Fx_condi_name]] &lt;- concat_df[[mean_Fx_condi_name]] - concat_df$coord/window_number ## Difference with the y=x ECDF, used to calculate AUC
  
  column_vector_value &lt;- character() ## obligatory to reset the columns values to empty
  column_vector_Fx &lt;- character()
}

return(concat_dfFx=concat_df)
}
</code></pre>
<pre><code class="language-r">concat_dfFX_res &lt;- calculates_meanFx(resultsECDF,200) ## 200 is because each gene is divided in 200 windows
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'resultsECDF' not found
</code></pre>
<h3 id="comparing-conditions">comparing conditions</h3>
<p>function to choose which condition to compare. prevents to have too big tables by comparing useless condition pairs</p>
<pre><code class="language-r"> condition_comparison &lt;- function(extension,working_directory){
  
res &lt;- getting_var_names(extension, working_directory)
Conditions &lt;- res$Conditions


for (i in 1:length(Conditions)) {
 for (j in (1+i):length(Conditions)) {
   if (j&gt;length(Conditions)){ break}
    cond1 &lt;- Conditions[i]
    cond2 &lt;- Conditions[j]
    
    newcol &lt;- paste0(cond1,&quot; vs &quot;, cond2)
    newcol_reverse &lt;- paste0(cond2,&quot; vs &quot;, cond1)
    print(newcol)
 #   print(newcol_reverse)
    }
 }
 }
</code></pre>
<pre><code class="language-r">condition_comparison(extension,working_directory)
</code></pre>
<p>If i dont want to compare some conditions because it is not relevant and it’s time consuming and memory consuming i can list them below</p>
<pre><code class="language-r">dontcompare_dtag &lt;- c(&quot;CPSF3depleted_ctrl vs CPSF3wt_HS&quot;, &quot;CPSF3depleted_HS vs CPSF3wt_ctrl&quot;) 

condition_compared &lt;- function(extension,working_directory,dontcompare=NULL){
  res &lt;- getting_var_names(extension, working_directory)
  Conditions &lt;- res$Conditions
for (i in 1:length(Conditions)) {
  cond1 &lt;- Conditions[i]
#  print(cond1)
  for (j in (1+i):length(Conditions)) {
  
     if (j&gt;length(Conditions)){ break}
      cond2 &lt;- Conditions[j]
   #    print(cond2)

   compare &lt;- paste0(cond1,&quot; vs &quot;, cond2)
   
   if (! compare %in% dontcompare ){
     print(compare)
     
   }

    
  #  newcol &lt;- &quot;&quot;
 #   print(newcol_reverse)
    }
}
}
</code></pre>
<pre><code class="language-r">condition_compared(extension,working_directory,)
</code></pre>
<pre><code class="language-r">Diff_mean_fun&lt;-function(concat_df, dontcompare=NULL){
  if(is.null(dontcompare)) {
  dontcompare &lt;- c() } 
  # return(dontcompare)
  
res &lt;- getting_var_names(extension, working_directory)
Conditions &lt;- res$Conditions
replicate_numbers &lt;- res$replicate_numbers


for (i in 1:length(Conditions)) {
  for (j in (1+i):length(Conditions)) {
    if (j&gt;length(Conditions)){ break}
    cond1 &lt;- Conditions[i]
    cond2 &lt;- Conditions[j]
    
    ## making sure to not do useless comparison for the user,
    compare &lt;- paste0(cond1,&quot; vs &quot;, cond2)
    if (! compare %in% dontcompare){
    
   # print(paste0(cond1,&quot;_&quot;,cond2))
   # print(paste0(cond2,&quot;_&quot;,cond1))
   # print(cond1,cond2)
    mean_value_condi_name1 &lt;- paste0(&quot;mean_value_&quot;, cond1)
    mean_value_condi_name2 &lt;- paste0(&quot;mean_value_&quot;, cond2)
    
    mean_Fx_condi_name1 &lt;- paste0(&quot;mean_Fx_&quot;, cond1)
    mean_Fx_condi_name2 &lt;- paste0(&quot;mean_Fx_&quot;, cond2)
    
    Diff_meanValue_name1 &lt;- paste0(&quot;Diff_meanValue_&quot;,cond1,&quot;_&quot;,cond2) 
    Diff_meanValue_name2 &lt;- paste0(&quot;Diff_meanValue_&quot;,cond2,&quot;_&quot;,cond1) 
    
    Diff_meanFx_name1 &lt;- paste0(&quot;Diff_meanFx_&quot;,cond1,&quot;_&quot;,cond2)
    Diff_meanFx_name2 &lt;- paste0(&quot;Diff_meanFx_&quot;,cond2,&quot;_&quot;,cond1) 
    #comparison_result &lt;- my_list[[element1]] - my_list[[element2]]
    
    concat_df[[Diff_meanValue_name1]] &lt;- concat_df[[mean_value_condi_name1]] - concat_df[[mean_value_condi_name2]]
    concat_df[[Diff_meanValue_name2]] &lt;- concat_df[[mean_value_condi_name2]] - concat_df[[mean_value_condi_name1]]
    
    concat_df[[Diff_meanFx_name1]] &lt;- concat_df[[mean_Fx_condi_name1]] - concat_df[[mean_Fx_condi_name2]]
    concat_df[[Diff_meanFx_name2]] &lt;- concat_df[[mean_Fx_condi_name2]] - concat_df[[mean_Fx_condi_name1]]
   }
  }
}

return(concat_df=concat_df)
}
</code></pre>
<pre><code class="language-r">concat_Diff_mean_res &lt;- Diff_mean_fun(concat_dfFX_res,)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'concat_dfFX_res' not found
</code></pre>
<h2 id="work-on-gene-summaries">Work on gene_summaries</h2>
<h4 id="lower-limit-for-pvalue-set-to-10-16">Lower limit for pValue set to 10^-16</h4>
<p>modify_p_values()</p>
<pre><code class="language-r">modify_p_values &lt;- function(col) {
  col &lt;- ifelse(col == 0.000000e+00, 10^(-16), col)
  return(col)
}
</code></pre>
<h3 id="dauc-calculation">dAUC calculation</h3>
<p>dAUC_allcondi_fun()</p>
<pre><code class="language-r">dAUC_allcondi_fun &lt;- function(concat_df,window_number, dontcompare){
  if(is.null(dontcompare)) {
  dontcompare &lt;- c() } 

dAUC_allcondi &lt;- concat_df  %&gt;% filter(window==round(window_number/2))  %&gt;% mutate(window_size = abs(coor2-coor1), .keep = &quot;all&quot;) %&gt;% select(&quot;transcript&quot;, &quot;gene&quot;, &quot;strand&quot;, &quot;window_size&quot;) %&gt;% distinct()

res &lt;- getting_var_names(extension, working_directory)
Conditions &lt;- res$Conditions


for (i in 1:length(Conditions)) {
 for (j in (1+i):length(Conditions)) {
   if (j&gt;length(Conditions)){ break}
    cond1 &lt;- Conditions[i]
    cond2 &lt;- Conditions[j]
    
        ## making sure to not do useless comparison for the user,
    compare &lt;- paste0(cond1,&quot; vs &quot;, cond2)
    if (! compare %in% dontcompare){
    
    mean_Fx_condi_name1 &lt;- paste0(&quot;mean_Fx_&quot;, cond1) #e,g Control
    mean_Fx_condi_name2 &lt;- paste0(&quot;mean_Fx_&quot;, cond2) #e.g HS

    Diff_meanFx_name1 &lt;- paste0(&quot;Diff_meanFx_&quot;,cond1,&quot;_&quot;,cond2)
    Diff_meanFx_name2 &lt;- paste0(&quot;Diff_meanFx_&quot;,cond2,&quot;_&quot;,cond1) 
    
      df_name &lt;- paste0(&quot;gene_summary_AUC_&quot;, Diff_meanFx_name1)
      assign(df_name,data.frame()) 
  
  # Get the data frame using the dynamically generated name
  dAUC_summary_condi_df &lt;- data.frame()
  dAUC_summary_condi_df &lt;- get(df_name)
    
  
  dAUC &lt;- paste0(&quot;dAUC_&quot;,Diff_meanFx_name2)
  p_dAUC &lt;- paste0(&quot;p_dAUC_&quot;,Diff_meanFx_name2)
  D_dAUC &lt;- paste0(&quot;D_dAUC_&quot;,Diff_meanFx_name2)
  
  dAUC_summary_condi_df  &lt;- concat_df %&gt;%
     group_by(transcript) %&gt;%
     arrange(coord) %&gt;%
     reframe(gene=gene[1],
            strand=strand, transcript=transcript, 
            !!dAUC := trapz(coord,!!sym(Diff_meanFx_name2)),# delta AUC
            !!p_dAUC := ks.test(!!sym(mean_Fx_condi_name1),!!sym(mean_Fx_condi_name2))$p.value,
            !!D_dAUC := ks.test(!!sym(mean_Fx_condi_name1),!!sym(mean_Fx_condi_name2))$statistic,
  ) %&gt;%
  dplyr::distinct()

      assign(df_name, dAUC_summary_condi_df)
  
  dAUC_allcondi &lt;- left_join(dAUC_allcondi, dAUC_summary_condi_df, by = c(&quot;transcript&quot;, &quot;gene&quot;,&quot;strand&quot;))
  
}
  }
}

  dAUC_allcondi &lt;- dAUC_allcondi %&gt;%
  mutate(across(contains(&quot;p_dAUC&quot;), ~ modify_p_values(.))) 

# Get the column names containing &quot;p_dAUC&quot;
p_dAUC_columns &lt;- grep(&quot;p_dAUC&quot;, colnames(dAUC_allcondi), value = TRUE)

# Loop through each column, calculate adjusted p-values, and create new columns
for (col_name in p_dAUC_columns) {
  print(col_name)
  adjusted_col_name &lt;- paste0(&quot;adjFDR_&quot;, col_name)
  dAUC_allcondi[[adjusted_col_name]] &lt;- p.adjust(dAUC_allcondi[[col_name]], method = &quot;fdr&quot;)
}


return(dAUC_allcondi)
}
</code></pre>
<pre><code class="language-r">dAUC_allcondi_res&lt;-dAUC_allcondi_fun(concat_Diff_mean_res,200, dontcompare_dtag)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'concat_Diff_mean_res' not found
</code></pre>
<h3 id="auc-calculation-amp-meanvaluefull">AUC calculation &amp; MeanValueFull</h3>
<p>AUC_allcondi_fun()</p>
<pre><code class="language-r"># Calculate the Area Under Curve (AUC), All conditions vs y=x 
# Calculate Mean Value over the full gene body in All conditions.

AUC_allcondi_fun &lt;- function(concat_df,window_number){

  # Load a library using require()
  if (!require(pracma)) {
    install.packages(&quot;pracma&quot;)
    library(pracma)
  }    
  
  
AUC_allcondi &lt;- concat_df %&gt;% filter(window==round(window_number/2))  %&gt;% mutate(window_size = abs(coor2-coor1), .keep = &quot;all&quot;) %&gt;% select(&quot;transcript&quot;, &quot;gene&quot;, &quot;strand&quot;, &quot;window_size&quot;) %&gt;% distinct()
res &lt;- getting_var_names(extension, working_directory)
Conditions &lt;- res$Conditions



n &lt;- window_number
cumulative_density &lt;- seq(1, n) / n

for (cond in Conditions) {
  #already present columns
  diff_Fx_condi_name &lt;- paste0(&quot;diff_Fx_&quot;, cond)
  mean_value_condi_name &lt;- paste0(&quot;mean_value_&quot;, cond)
  mean_Fx_condi_name &lt;- paste0(&quot;mean_Fx_&quot;, cond)

  df_name &lt;- paste0(&quot;gene_summary_AUC_&quot;, cond)
  assign(df_name,data.frame()) 
  
  # Get the data frame using the dynamically generated name
  AUC_summary_condi_df &lt;- data.frame()
  AUC_summary_condi_df &lt;- get(df_name)
  
  #new column
  AUC &lt;- paste0(&quot;AUC_&quot;, cond)
  p_AUC &lt;- paste0(&quot;p_AUC_&quot;, cond)
  D_AUC &lt;- paste0(&quot;D_AUC_&quot;, cond)
  MeanValueFull_condi_name &lt;- paste0(&quot;MeanValueFull_&quot;, cond) #mean value over the full gene body
  
  AUC_summary_condi_df &lt;- concat_df %&gt;%
    group_by(transcript) %&gt;%
    arrange(coord) %&gt;% 
    reframe(gene=gene[1], 
              !!AUC := trapz(coord,!!sym(diff_Fx_condi_name)) ,
              !!p_AUC := ks.test(!!sym(mean_Fx_condi_name),cumulative_density)$p.value,
              !!D_AUC := ks.test(!!sym(mean_Fx_condi_name),cumulative_density)$statistic,
              strand=strand,
              transcript=transcript, 
              !!(MeanValueFull_condi_name) :=mean(!!sym(mean_value_condi_name))) %&gt;% 
    dplyr::distinct()
  
  assign(df_name, AUC_summary_condi_df)
  
  AUC_allcondi &lt;- left_join(AUC_allcondi, AUC_summary_condi_df, by = c(&quot;transcript&quot;, &quot;gene&quot;,&quot;strand&quot;))
}

  AUC_allcondi &lt;- AUC_allcondi %&gt;%
  mutate(across(contains(&quot;p_AUC&quot;), ~ modify_p_values(.))) 

# Get the column names containing &quot;p_dAUC&quot;
p_AUC_columns &lt;- grep(&quot;p_AUC&quot;, colnames(AUC_allcondi), value = TRUE)

# Loop through each column, calculate adjusted p-values, and create new columns
for (col_name in p_AUC_columns) {
  print(col_name)
  adjusted_col_name &lt;- paste0(&quot;adjFDR_&quot;, col_name)
  AUC_allcondi[[adjusted_col_name]] &lt;- p.adjust(AUC_allcondi[[col_name]], method = &quot;fdr&quot;)
}

return(AUC_allcondi)
}
# rm(AUC_allcondi)
</code></pre>
<pre><code class="language-r">AUC_allcondi_res &lt;- AUC_allcondi_fun(concat_Diff_mean_res,200) 
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'concat_Diff_mean_res' not found
</code></pre>
<h4 id="counting-nas">Counting NAs</h4>
<p>countNA_fun()</p>
<pre><code class="language-r">countNA_fun &lt;- function(main_table,extension,working_directory){
res &lt;- getting_var_names(extension, working_directory)
col_names &lt;- res$col_names
score_columns &lt;- grep(&quot;score$&quot;, col_names, value = TRUE)  

##Adding NA count
Count_NA &lt;- main_table %&gt;%
  group_by(transcript) %&gt;%
  dplyr::reframe(gene=gene[1], strand = strand[1], 
                   across(all_of(score_columns), ~ mean(., na.rm = TRUE), .names = &quot;{.col}_mean&quot;), #score_columns obtained in the first chunk creating densities 
                   across(contains(&quot;score&quot;), ~ sum(is.na(.)), .names = &quot;{.col}_NA&quot;)) %&gt;%
  select(-contains(&quot;_mean_NA&quot;)) %&gt;%
  set_names(map_chr(names(.), ~ ifelse(str_detect(.x, &quot;score&quot;) &amp;&amp; str_detect(.x, &quot;_NA&quot;), str_replace(.x, &quot;_score&quot;, &quot;_count&quot;), .x)))

NA_plus &lt;- Count_NA %&gt;%
  filter(strand==&quot;+&quot;) %&gt;%   select(gene, transcript, strand, contains(&quot;plus&quot;)) %&gt;%  select(gene, transcript, strand, contains(&quot;NA&quot;)) %&gt;%
  set_names(map_chr(names(.), ~ ifelse(str_detect(.x, &quot;plus&quot;) &amp;&amp; str_detect(.x, &quot;_NA&quot;), str_replace(.x, &quot;.plus_&quot;, &quot;_strand_&quot;), .x)))
NA_minus &lt;- Count_NA %&gt;%
  filter(strand==&quot;-&quot;) %&gt;%   select(gene, transcript,strand, contains(&quot;minus&quot;)) %&gt;%  select(gene, transcript,strand, contains(&quot;NA&quot;)) %&gt;%
  set_names(map_chr(names(.), ~ ifelse(str_detect(.x, &quot;minus&quot;) &amp;&amp; str_detect(.x, &quot;_NA&quot;), str_replace(.x, &quot;.minus_&quot;, &quot;_strand_&quot;), .x)))

rm(Count_NA)

NA_test &lt;- bind_rows(NA_plus, NA_minus) %&gt;% 
  select(gene, transcript, strand, matches(&quot;_count_NA&quot;)) %&gt;%
  select(1:4)  %&gt;%
  dplyr::rename(Count_NA = matches(&quot;count_NA&quot;)) # I drop the other NA columns because it is the same value for all the conditions (NA depends on blacklist and unmmapable region)

return(NA_test)
}
</code></pre>
<pre><code class="language-r">library(stringr)
count_NA_res &lt;- countNA_fun(main_table,extension,working_directory)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'main_table' not found
</code></pre>
<h3 id="knee-identification">Knee identification</h3>
<pre><code class="language-r">## this will maybe need to call &quot;Conditions&quot;
KneeID_fun &lt;- function(concat_df){
gene_summary_allcondi &lt;- concat_df %&gt;% select(&quot;transcript&quot;) %&gt;% distinct()

res &lt;- getting_var_names(extension, working_directory)
Conditions &lt;- res$Conditions

for (cond in Conditions) {
  diff_Fx_condi_name &lt;- paste0(&quot;diff_Fx_&quot;, cond)
  df_name &lt;- paste0(&quot;gene_summary_AUC_&quot;, cond)
  assign(df_name,data.frame()) 
  
  # Get the data frame using the dynamically generated name
  gene_summary_condi_df &lt;- data.frame()
  gene_summary_condi_df &lt;- get(df_name)
  
  # Perform operations on the data frame
  # For example, add columns or rows to the data frame
  max_column_name &lt;- paste0(&quot;max_&quot;, diff_Fx_condi_name)
  knee_column_name &lt;- paste0(&quot;knee_AUC_&quot;, cond)
  
  
  gene_summary_condi_df &lt;- concat_df %&gt;%
    dplyr::group_by(transcript)  %&gt;%
    dplyr::filter(!!sym(diff_Fx_condi_name) == max(!!sym(diff_Fx_condi_name)))  %&gt;% # !!sym() inside the filter() to convert the variable name to a symbol and then access the column using the !! operator.
    slice_min(coord, n = 1)  %&gt;% #if equality of difference within the same gene it takes the closest knee from the TSS
    select(transcript, coord, diff_Fx_condi_name)  %&gt;%
    dplyr::rename(!!max_column_name := !!sym(diff_Fx_condi_name)) %&gt;%
    dplyr::rename(!!knee_column_name := coord) ## the knee position is defined as the max difference between the ecdf and y=x curve
  
  # Assign the modified data frame back to the dynamically generated name
  assign(df_name, gene_summary_condi_df)
  
  gene_summary_allcondi &lt;- left_join(gene_summary_allcondi, gene_summary_condi_df, by = &quot;transcript&quot;)
  
}
return(gene_summary_allcondi)
}
#Working
</code></pre>
<pre><code class="language-r">KneeID_res &lt;- KneeID_fun(concat_Diff_mean_res)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'concat_Diff_mean_res' not found
</code></pre>
<h4 id="joining">Joining</h4>
<pre><code class="language-r">AUC_KS_Knee_NA.df &lt;- left_join(AUC_allcondi_res, dAUC_allcondi_res, by=c(&quot;transcript&quot;, &quot;gene&quot;, &quot;strand&quot;,&quot;window_size&quot;))  %&gt;% 
  left_join(.,KneeID_res, by=c(&quot;transcript&quot;))  %&gt;% 
  left_join(.,count_NA_res, by=c(&quot;gene&quot;, &quot;transcript&quot;, &quot;strand&quot;))
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'AUC_allcondi_res' not found
</code></pre>
<pre><code class="language-r">AUC_KS_Knee_NA.df &lt;- concat_Diff_mean_res %&gt;% group_by(transcript) %&gt;% summarise( chr=chr[1], coor1=min(coor1), coor2=max(coor2), strand=strand[1], gene=gene[1], transcript=transcript[1], size=coor2-coor1+1) %&gt;% left_join(AUC_KS_Knee_NA.df, by=c(&quot;gene&quot;, &quot;transcript&quot;, &quot;strand&quot;) )
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'concat_Diff_mean_res' not found
</code></pre>
<pre><code class="language-r">Attenuation_fun&lt;- function(AUC_KS_Knee_NA_DF, concat_df, pval,Replaced){
  res&lt;-getting_var_names(extension, working_directory)
  Conditions &lt;- res$Conditions

  Complete_summary &lt;-  left_join(concat_df, AUC_KS_Knee_NA_DF, by = c(&quot;gene&quot;,&quot;transcript&quot;,&quot;strand&quot;))
  
  for (cond in Conditions) {
    mean_value_condi_name &lt;- paste0(&quot;mean_value_&quot;, cond)
    print(mean_value_condi_name)
    knee_column_name &lt;- paste0(&quot;knee_AUC_&quot;, cond)
    
    Attenuation_cond &lt;- paste0(&quot;Attenuation_&quot;, cond)
    
    UPmean_cond &lt;- paste0(&quot;UP_mean_&quot;, cond)
    DOWNmean_cond &lt;- paste0(&quot;DOWN_mean_&quot;, cond)
    
    AUC_KS_Knee_NA_DF[[Attenuation_cond]] &lt;- NA
    
    
    result &lt;- Complete_summary %&gt;%
    group_by(transcript) %&gt;%
    arrange(coord) %&gt;%
    dplyr::reframe(transcript=transcript[1],
                     !!sym(UPmean_cond) := 
                       mean((!!sym(mean_value_condi_name))[coord &lt;= !!sym(knee_column_name)]),
                     !!sym(DOWNmean_cond) := 
                       mean((!!sym(mean_value_condi_name))[coord &gt;= !!sym(knee_column_name) &amp; coord &lt;= max(coord)])) %&gt;%
      select(transcript,!!sym(UPmean_cond),!!sym(DOWNmean_cond), !!sym(DOWNmean_cond)) %&gt;%
   distinct()
    
    AUC_KS_Knee_NA_DF &lt;- left_join(AUC_KS_Knee_NA_DF,result, by=c(&quot;transcript&quot;))
    AUC_KS_Knee_NA_DF[[Attenuation_cond]] &lt;- 100- AUC_KS_Knee_NA_DF[[DOWNmean_cond]]/AUC_KS_Knee_NA_DF[[UPmean_cond]]*100
  }
  

if (exists(&quot;Replaced&quot;) &amp;&amp; !is.na(Replaced)) {
  if (Replaced != &quot;NOT&quot;) {
  for (cond in Conditions) {
  p_AUC_cond &lt;- paste0(&quot;p_AUC_&quot;, cond)
  print(p_AUC_cond)
  AUC_KS_Knee_NA_DF &lt;- AUC_KS_Knee_NA_DF %&gt;%
    mutate(!!paste0(&quot;Attenuation_&quot;, cond) := ifelse(.data[[p_AUC_cond]] &gt;= pval, Replaced, .data[[paste0(&quot;Attenuation_&quot;, cond)]])) ## replacing the Attenuation by an inout value is KS test &gt; at threshold
  AUC_KS_Knee_NA_DF &lt;- AUC_KS_Knee_NA_DF %&gt;%
    mutate(!!paste0(&quot;knee_AUC_&quot;, cond) := ifelse(.data[[p_AUC_cond]] &gt;= pval, NA, .data[[paste0(&quot;knee_AUC_&quot;, cond)]])) ## replacing the knee by NA is KS test &gt; at threshold
  }
  }
} else {
    for (cond in Conditions) {
      p_AUC_cond &lt;- paste0(&quot;p_AUC_&quot;, cond)
      print(p_AUC_cond)
      AUC_KS_Knee_NA_DF &lt;- AUC_KS_Knee_NA_DF %&gt;%
        mutate(!!paste0(&quot;Attenuation_&quot;, cond) := ifelse(.data[[p_AUC_cond]] &gt;= pval, NA, .data[[paste0(&quot;Attenuation_&quot;, cond)]])) ## replacing the Attenuation by an input value if KS test &gt; at threshold
      AUC_KS_Knee_NA_DF &lt;- AUC_KS_Knee_NA_DF %&gt;%
        mutate(!!paste0(&quot;knee_AUC_&quot;, cond) := ifelse(.data[[p_AUC_cond]] &gt;= pval, NA, .data[[paste0(&quot;knee_AUC_&quot;, cond)]])) ## replacing the knee by NA if KS test &gt; at threshold
    }
}


  return(AUC_KS_Knee_NA_DF)
}
</code></pre>
<pre><code class="language-r">gc()
</code></pre>
<pre><code>##           used  (Mb) gc trigger  (Mb) max used  (Mb)
## Ncells 2179922 116.5    4361044 233.0  4361044 233.0
## Vcells 4219544  32.2   10146329  77.5  6514607  49.8
</code></pre>
<pre><code class="language-r">tst_df &lt;- Attenuation_fun(AUC_KS_Knee_NA.df, concat_Diff_mean_res, 0.1, &quot;NOT&quot; ) #&quot;NOT&quot; (not replaced) or a number for attenuation (usually 0) or NA
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'concat_Diff_mean_res' not found
</code></pre>
<h2 id="subdata">subdata</h2>
<p>Creating filters to group genes</p>
<pre><code class="language-r">tst_df &lt;- tst_df %&gt;%
  mutate(Universe = ifelse(window_size &gt; 50 &amp; Count_NA &lt; 20 &amp; !!sym(mean_value_control_full) &gt; 0.5 &amp; !!sym(mean_value_stress) &gt; 0.5 &amp;
                             !!sym(p_value_theoritical)&gt; 0.1,
                             TRUE, FALSE)) %&gt;%
  relocate(Universe, .before = 1)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'tst_df' not found
</code></pre>
<pre><code class="language-r">tst_df &lt;- tst_df %&gt;%
  mutate(
    Group = ifelse(Universe == TRUE &amp; !!sym(AUC_stress) &gt; 15 &amp; -log10(!!sym(p_value_KStest))&gt;1.5, &quot;Attenuated&quot;, NA),
    Group = ifelse(Universe == TRUE &amp; !!sym(p_value_KStest)&gt;0.2 &amp; !!sym(AUC_ctrl) &gt; -10 &amp; !!sym(AUC_ctrl) &lt; 15 , &quot;Outgroup&quot;, Group)  
  ) %&gt;%
  relocate(Group, .before = 2)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'tst_df' not found
</code></pre>
<h1 id="write-and-read-tsv">Write and Read tsv</h1>
<h2 id="write">Write</h2>
<pre><code class="language-r">PATH &lt;- &quot;&quot;
rounding &lt;- 10 #by default
window_n &lt;- 200 #by default
PaperYear &lt;- &quot;SousaLuis2021_PlaB&quot;
</code></pre>
<p>Write</p>
<pre><code class="language-r">## tst_df is important for plotting all genes together.
tst_df_path &lt;- paste0(PATH,PaperYear,&quot;_AttenuationScores_&quot;,rounding,&quot;_&quot;,window_n,&quot;.tsv&quot;)
write.table(tst_df, file = tst_df_path, sep = &quot;\t&quot;, quote = FALSE, row.names = FALSE, col.names = T)
</code></pre>
<pre><code>## Error in eval(expr, envir, enclos): object 'tst_df' not found
</code></pre>
<h2 id="read">Read</h2>
<p>Cugusi 2rep</p>
<pre><code class="language-r">working_directory &lt;- &quot;/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/Cugusi2022/RAW_TTseq/deduplicated/MAPQ255/stranded/bedgraph255&quot;
extension &lt;- &quot;*.bg&quot;

PATH &lt;- &quot;/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/Cugusi2022/RAW_TTseq/&quot;
rounding &lt;- 10
window_n &lt;- 200
PaperYear &lt;- &quot;Cugusi2022&quot;

mean_value_control_full &lt;- &quot;MeanValueFull_ctrl&quot;
mean_value_stress &lt;- &quot;MeanValueFull_HS&quot;
AUC_ctrl &lt;- &quot;AUC_ctrl&quot;
AUC_stress &lt;- &quot;AUC_HS&quot;
p_value_KStest &lt;- &quot;adjFDR_p_dAUC_Diff_meanFx_HS_ctrl&quot;
p_value_theoritical&lt;- &quot;adjFDR_p_AUC_ctrl&quot; 
</code></pre>
<pre><code class="language-r">## resultsECDF is important for cumulative transcription plot
resultsECDF_path &lt;- paste0(PATH,PaperYear,&quot;_ECDFScores_&quot;,rounding,&quot;_&quot;,window_n,&quot;.tsv&quot;)
resultsECDF &lt;- read.delim(resultsECDF_path,
                        header = T, # set header = FALSE to avoid overwriting it
                        sep=&quot;\t&quot;)
</code></pre>
<pre><code>## Warning in file(file, &quot;rt&quot;): cannot open file
## '/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/Cugusi2022/RAW_TTseq/Cugusi2022_ECDFScores_10_200.tsv':
## No such file or directory
</code></pre>
<pre><code>## Error in file(file, &quot;rt&quot;): cannot open the connection
</code></pre>
<pre><code class="language-r">## tst_df is important for plotting all genes together.
tst_df_path &lt;- paste0(PATH,PaperYear,&quot;_AttenuationScores_&quot;,rounding,&quot;_&quot;,window_n,&quot;.tsv&quot;)
tst_df &lt;- read.delim(tst_df_path,
                        header = T, # set header = FALSE to avoid overwriting it
                        sep=&quot;\t&quot;)
</code></pre>
<pre><code>## Warning in file(file, &quot;rt&quot;): cannot open file
## '/Volumes/cristo-nas-shared/Personal_documents/Victor/DATA/Cugusi2022/RAW_TTseq/Cugusi2022_AttenuationScores_10_200.tsv':
## No such file or directory
</code></pre>
<pre><code>## Error in file(file, &quot;rt&quot;): cannot open the connection
</code></pre>
</div>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
</body>
</html>
